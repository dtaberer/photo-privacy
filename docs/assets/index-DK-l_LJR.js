const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/face-api-BjDtJm7n.js","assets/vendor-C3Tnp9W3.js","assets/react-vendor-PxcwVTN2.js"])))=>i.map(i=>d[i]);
import{R as xe,j as s,r as l,C as ne,B as je,F as se,S as Ae,a as be,b as _e,c as He,d as Te,e as Be,f as Ue,h as $e,i as We,k as ze,l as Xe,m as Ye,n as ye,o as Ge}from"./react-vendor-PxcwVTN2.js";import{b as te,F as ve,H as Ve}from"./onnxruntime-20T2sGtg.js";/* empty css                         */import"./vendor-C3Tnp9W3.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const m of a)if(m.type==="childList")for(const b of m.addedNodes)b.tagName==="LINK"&&b.rel==="modulepreload"&&i(b)}).observe(document,{childList:!0,subtree:!0});function e(a){const m={};return a.integrity&&(m.integrity=a.integrity),a.referrerPolicy&&(m.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?m.credentials="include":a.crossOrigin==="anonymous"?m.credentials="omit":m.credentials="same-origin",m}function i(a){if(a.ep)return;a.ep=!0;const m=e(a);fetch(a.href,m)}})();let Me=!1;function Se(n){if(typeof window<"u"&&window.__TEST__||Me)return;const r=typeof window<"u"?`${window.location.origin}/ort-runtime/`:"/ort-runtime/";te.wasm.wasmPaths=r,te.wasm.simd=!0,te.wasm.numThreads=1,te.wasm.proxy=!1,Me=!0}function Ze(){te.wasm.simd=!1,te.wasm.numThreads=1,te.wasm.proxy=!1}async function qe(n,r){Se();const e={executionProviders:["wasm"],...r};if(typeof n=="string")return ve.create(n,e);const i=n instanceof Uint8Array?n:new Uint8Array(n);return ve.create(i,e)}const Je="/photo-privacy/assets/bubble-blower-x8rhTqNL.jpg";function Ke(){return s.jsxs("div",{className:"pps-hero my-3",style:{backgroundImage:`url(${Je})`},children:[s.jsx("h1",{className:"display-5 fw-bold mt-2 mb-1",children:"Photo Privacy Scrubber"}),s.jsx("div",{children:s.jsx("span",{className:"pps-subtitle",children:"Redact Faces • Redact Plates • Strip EXIF • No Data Leaves Your Browser!"})})]})}const Qe=xe.memo(Ke);function et(n,r="redacted.jpg",e="image/jpeg",i=.92){if(!n)return;const a=e==="image/jpeg";n.toBlob(m=>{if(!m)return;const b=URL.createObjectURL(m),C=document.createElement("a");C.href=b,C.download=r,C.click(),setTimeout(()=>URL.revokeObjectURL(b),0)},e,a?i:void 0)}function tt(n){const r=Object.values(n);if(r.length===0)throw new Error("Model returned no outputs");return r[0]}function nt(n){const r=n.dims??[],e=n.data;if(!(e instanceof Float32Array))throw new Error("Output tensor is not Float32Array");return{data:e,dims:r}}function st(n,r){n.sort((i,a)=>a.conf-i.conf);const e=[];for(const i of n)e.every(a=>rt(a,i)<=r)&&e.push(i);return e}function rt(n,r){const e=n.x+n.w,i=n.y+n.h,a=r.x+r.w,m=r.y+r.h,b=Math.max(n.x,r.x),C=Math.max(n.y,r.y),p=Math.min(e,a),x=Math.min(i,m),u=Math.max(0,p-b),M=Math.max(0,x-C),t=u*M,c=n.w*n.h+r.w*r.h-t;return c>0?t/c:0}function at(n,r){const e=Math.round(r),i=n.naturalWidth,a=n.naturalHeight,m=Math.min(e/i,e/a),b=Math.round(i*m),C=Math.round(a*m),p=Math.floor((e-b)/2),x=Math.floor((e-C)/2),u=document.createElement("canvas");u.width=e,u.height=e;const M=u.getContext("2d");if(!M)throw new Error("2D context unavailable");M.fillStyle="black",M.fillRect(0,0,e,e),M.drawImage(n,0,0,i,a,p,x,b,C);const{data:t}=M.getImageData(0,0,e,e),c=e*e,v=new Float32Array(3*c);for(let o=0,f=0;o<c;o++,f+=4)v[o]=(t[f]??0)/255,v[c+o]=(t[f+1]??0)/255,v[2*c+o]=(t[f+2]??0)/255;return{input:v,scale:m,pad:{x:p,y:x},S:e}}function ot(n,r,e){const i=[],a=e.pad.x,m=e.pad.y,b=e.scale,C=e.padRatio;let p=0,x=0,u;if(r.length===3){const[,t,c]=r;t>=5&&t<=256?(p=t,x=c,u=(v,o)=>n[o*x+v]??0):(p=c,x=t,u=(v,o)=>n[v*p+o]??0)}else if(r.length===2){const[t,c]=r;c>=5?(p=c,x=t,u=(v,o)=>n[v*p+o]??0):(p=t,x=c,u=(v,o)=>n[o*x+v]??0)}else p=6,x=Math.floor(n.length/p),u=(t,c)=>n[t*p+c]??0;const M=Math.min(x,e.max);for(let t=0;t<M;t++){const c=u(t,0),v=u(t,1),o=u(t,2),f=u(t,3);let w=u(t,4);if(p>5){let d=0;for(let E=5;E<p;E++)d=Math.max(d,u(t,E));w=w*d}if(!isFinite(w)||w<e.conf||!isFinite(c)||!isFinite(v)||!isFinite(o)||!isFinite(f))continue;let N=c-o/2,T=v-f/2;N=(N-a)/b,T=(T-m)/b;const R=o/b,I=f/b,j=R*C,h=I*C;i.push({x:N-j,y:T-h,w:R+2*j,h:I+2*h,conf:w})}return i}function ct(n,r,e,i,a,m,b,C){const p=Math.max(1,Math.round(b/100*40)),x=Math.ceil(p*2+Math.max(0,C)),u=Math.max(0,Math.floor(e-x)),M=Math.max(0,Math.floor(i-x)),t=Math.min(r.naturalWidth-u,Math.ceil(a+2*x)),c=Math.min(r.naturalHeight-M,Math.ceil(m+2*x));if(t<=0||c<=0)return;const v=document.createElement("canvas");v.width=t,v.height=c;const o=v.getContext("2d");if(o){if(o.filter=`blur(${p}px)`,o.drawImage(r,u,M,t,c,0,0,t,c),o.filter="none",C>0){const f=document.createElement("canvas");f.width=t,f.height=c;const w=f.getContext("2d"),N=Math.max(0,Math.floor(e-u)),T=Math.max(0,Math.floor(i-M)),R=Math.min(t,Math.ceil(a)),I=Math.min(c,Math.ceil(m));w.fillStyle="#000",w.fillRect(0,0,t,c),w.fillStyle="#fff",w.fillRect(N,T,R,I),w.filter=`blur(${C}px)`;const j=document.createElement("canvas");j.width=t,j.height=c;const h=j.getContext("2d");h.filter=`blur(${C}px)`,h.drawImage(f,0,0),h.filter="none",o.globalCompositeOperation="destination-in",o.drawImage(j,0,0),o.globalCompositeOperation="source-over"}else{o.globalCompositeOperation="destination-in";const f=document.createElement("canvas");f.width=t,f.height=c;const w=f.getContext("2d");w.fillStyle="#fff",w.fillRect(Math.max(0,Math.floor(e-u)),Math.max(0,Math.floor(i-M)),Math.min(t,Math.ceil(a)),Math.min(c,Math.ceil(m))),o.drawImage(f,0,0),o.globalCompositeOperation="source-over"}n.drawImage(v,u,M)}}function Ce(n,r){return n.filter(e=>{const i=typeof e.conf=="number"?e.conf:typeof e.conf=="string"?parseFloat(e.conf):NaN;return Number.isFinite(i)&&i>=r})}const fe="/photo-privacy/",De=fe.endsWith("/")?fe:`${fe}/`,it=!1,z={BLUR_DENSITY:40,CONFIDENCE_THRESHOLD:.02,RUN_FACE_DETECTION:!0,IOU_THRESHOLD:.1,PAD_RATIO:.1,FEATHER_PX:1,MAX_DETECTED_FACES:50,MODEL_SIZE:320,MODELS_URL:`${De}models/face-api`},V={BLUR_DENSITY:40,CONFIDENCE_THRESHOLD:.02,RUN_LICENSE_PLATE_DETECTION:!0,MODEL_SIZE:800,MODEL_URL:`${De}models/license-plate-finetune-v1n.onnx`,IOU_THRESHOLD:.1,PAD_RATIO:.01,FEATHER_PX:1},lt={w:1280,h:720},Ee={count:0,total:0,timings:{preprocess:0,run:0,post:0,total:0}};let ue=null,me="",oe=[];async function dt(n){if(ue)return{plateSession:ue,plateInputName:me};Ze();const r=await fetch(n,{cache:"no-store"});if(!r.ok)throw new Error(`Model HTTP ${r.status}`);const e=await r.arrayBuffer(),i=await qe(e);return ue=i,me=i.inputNames?.[0]??"images",{plateSession:ue,plateInputName:me}}const ut=l.forwardRef(({imgRef:n,canvasRef:r,opts:e},i)=>{const a=l.useRef(!1),m=l.useCallback(async()=>{const p=n.current,x=r.current;if(!p||!x)return;const u=x.getContext("2d");if(!u)return;u.clearRect(0,0,x.width,x.height);const M=Ce(oe,e.confThresh);for(const t of M){const c=Math.max(0,Math.floor(t.x)),v=Math.max(0,Math.floor(t.y)),o=Math.min(x.width-c,Math.ceil(t.w)),f=Math.min(x.height-v,Math.ceil(t.h));o>0&&f>0&&ct(u,p,c,v,o,f,e.blurStrength,e.featherPx??0)}},[r,n,e.blurStrength,e.confThresh,e.featherPx]),b=l.useCallback(async()=>{if(!a.current){a.current=!0;try{const p=n.current,x=r.current;if(!p||!x)return;const{plateSession:u,plateInputName:M}=await dt(V.MODEL_URL),t=performance.now(),c=V.MODEL_SIZE,{input:v,scale:o,pad:f}=at(p,c),w=new Ve("float32",v,[1,3,c,c]),N={[M]:w},T=performance.now(),R=await u.run(N),I=performance.now(),j=tt(R),{data:h,dims:d}=nt(j),E=ot(h,d,{conf:V.CONFIDENCE_THRESHOLD,pad:f,scale:o,padRatio:V.PAD_RATIO,max:3e4});oe=st(E,V.IOU_THRESHOLD),await m();const g=performance.now(),y=Ce(oe,e.confThresh).length;e.setPerfReport({count:y,timings:{preprocess:T-t,run:I-T,post:g-I,total:g-t},total:g-t})}catch(p){console.log("Error inside of LicensePlateBlur:",p)}finally{a.current=!1}}},[n,r,m,e]),C=l.useCallback(async()=>{await m()},[m]);return l.useImperativeHandle(i,()=>({run:b,redraw:C,getDetections:()=>oe.map(p=>({x:p.x,y:p.y,w:p.w,h:p.h})),reset:()=>{oe=[]}}),[b,C]),null}),ht="modulepreload",ft=function(n){return"/photo-privacy/"+n},Re={},mt=function(r,e,i){let a=Promise.resolve();if(e&&e.length>0){let p=function(x){return Promise.all(x.map(u=>Promise.resolve(u).then(M=>({status:"fulfilled",value:M}),M=>({status:"rejected",reason:M}))))};document.getElementsByTagName("link");const b=document.querySelector("meta[property=csp-nonce]"),C=b?.nonce||b?.getAttribute("nonce");a=p(e.map(x=>{if(x=ft(x),x in Re)return;Re[x]=!0;const u=x.endsWith(".css"),M=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${x}"]${M}`))return;const t=document.createElement("link");if(t.rel=u?"stylesheet":ht,u||(t.as="script"),t.crossOrigin="",t.href=x,C&&t.setAttribute("nonce",C),document.head.appendChild(t),u)return new Promise((c,v)=>{t.addEventListener("load",c),t.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${x}`)))})}))}function m(b){const C=new Event("vite:preloadError",{cancelable:!0});if(C.payload=b,window.dispatchEvent(C),!C.defaultPrevented)throw b}return a.then(b=>{for(const C of b||[])C.status==="rejected"&&m(C.reason);return r().catch(m)})},k=(n,r,e)=>Math.max(r,Math.min(e,n));function gt(n,r,e){const i=n.getBoundingClientRect();if(i.width<=0||i.height<=0)return{x:Math.round(e.x),y:Math.round(e.y),w:Math.round(e.width),h:Math.round(e.height)};const a=r.width/i.width,m=r.height/i.height;return{x:Math.round(e.x*a),y:Math.round(e.y*m),w:Math.round(e.width*a),h:Math.round(e.height*m)}}function ge(n,r,e,i=.12){const a=Math.round(n.h*i),m=k(n.y-a,0,e),b=k(n.h+a,1,e-m);return{...n,y:m,h:b}}function pe(n,r,e,i,a,m,b,C){const p=n.canvas.width,x=n.canvas.height,u=Math.ceil(Math.max(0,b)*1.5+Math.max(0,C)+4),M=k(Math.floor(e-u),0,p),t=k(Math.floor(i-u),0,x),c=k(Math.ceil(e+a+u),0,p),v=k(Math.ceil(i+m+u),0,x),o=c-M,f=v-t;if(o<=0||f<=0)return;const w=document.createElement("canvas");w.width=o,w.height=f;const N=w.getContext("2d");if(!N)return;N.drawImage(r,M,t,o,f,0,0,o,f);const T=document.createElement("canvas");T.width=o,T.height=f;const R=T.getContext("2d");if(!R)return;R.filter=`blur(${Math.max(0,Math.round(b))}px)`,R.drawImage(w,0,0),R.filter="none";const I=document.createElement("canvas");I.width=o,I.height=f;const j=I.getContext("2d");if(!j)return;const h=e-M+a/2,d=i-t+m/2,E=Math.max(1,a/2),g=Math.max(1,m/2);j.save(),j.translate(h,d);const y=Math.max(E,g);if(j.scale(E/y,g/y),C<=0)j.fillStyle="rgba(0,0,0,1)",j.beginPath(),j.arc(0,0,y,0,Math.PI*2),j.fill();else{const P=Math.max(0,y-C),O=j.createRadialGradient(0,0,P,0,0,y);O.addColorStop(0,"rgba(0,0,0,1)"),O.addColorStop(1,"rgba(0,0,0,0)"),j.fillStyle=O,j.beginPath(),j.arc(0,0,y,0,Math.PI*2),j.fill()}j.restore(),R.save(),R.globalCompositeOperation="destination-in",R.drawImage(I,0,0),R.restore(),n.drawImage(T,M,t)}function pt(n){if(!n||typeof n!="object")return!1;const r=n,e=typeof r.detectAllFaces=="function",i=typeof r.TinyFaceDetectorOptions=="function",a=r.nets,m=!!a&&typeof a=="object"&&"tinyFaceDetector"in a;return e&&i&&m}let G=[];const xt=l.forwardRef(({imgRef:n,canvasRef:r,opts:e},i)=>{const a=globalThis.FaceDetector,m=l.useCallback(async()=>{const M=n.current,t=r.current;if(!M||!t)return;const c=performance.now();G=[];const v=z.BLUR_DENSITY,o=k(e.confThresh??z.CONFIDENCE_THRESHOLD,.01,.99),f=z.PAD_RATIO;if(a){let S=performance.now(),X=S;try{const $=new a({fastMode:!1,maxDetectedFaces:64});S=performance.now();const U=await $.detect(M);X=performance.now(),G=U.map(F=>{const _="boundingBox"in F?F.boundingBox:"box"in F?F.box:{x:F.x,y:F.y,width:F.width,height:F.height};return gt(M,t,_)})}catch{G=[]}try{const $=t.getContext("2d"),U=G.filter(F=>(F.score??1)>=o);for(const F of U){const _=F,H=t.width,ae=t.height,ce=k(Math.round(_.x-_.w*f),0,H),ie=k(Math.round(_.y-_.h*f),0,ae),le=k(Math.round(_.w*(1+2*f)),1,H-ce),de=k(Math.round(_.h*(1+2*f)),1,ae-ie),Q=ge({x:ce,y:ie,w:le,h:de},H,ae,.12);$&&pe($,M,Q.x,Q.y,Q.w,Q.h,v,z.FEATHER_PX)}}catch{}const K=performance.now();e.setPerfReport({count:G.filter($=>($.score??1)>=o).length,total:K-c,timings:{preprocess:S-c,run:X-S,post:K-X,total:K-c}});return}let w;try{w=await mt(()=>import("./face-api-BjDtJm7n.js"),__vite__mapDeps([0,1,2]))}catch{w=void 0}if(!pt(w)){e.setPerfReport({count:0,total:0,timings:{preprocess:0,run:0,post:0,total:0}});return}const N=w,T="/photo-privacy/",R=T.endsWith("/")?T:`${T}/`,I=[z.MODELS_URL,`${R}models/face`,`${R}models`,"/models/face","/models"].filter(S=>typeof S=="string"&&S.length>0);let j=!1;for(const S of I)try{await N.nets.tinyFaceDetector.loadFromUri(S),j=!0;break}catch{}if(!j){e.setPerfReport({count:0,total:0,timings:{preprocess:0,run:0,post:0,total:0}});return}const h=performance.now(),d=k(Math.round((e.modelSize??544)/32)*32,128,1024),E=new N.TinyFaceDetectorOptions({scoreThreshold:o,inputSize:d}),g=await N.detectAllFaces(M,E),y=performance.now(),P=t.width/(M.naturalWidth||t.width),O=t.height/(M.naturalHeight||t.height);G=g.map(S=>({x:Math.round(S.box.x*P),y:Math.round(S.box.y*O),w:Math.round(S.box.width*P),h:Math.round(S.box.height*O),score:S.score??1}));const Z=t.getContext("2d"),q=G.filter(S=>(S.score??1)>=o);for(const S of q){const X=t.width,K=t.height,$=k(Math.round(S.x-S.w*f),0,X),U=k(Math.round(S.y-S.h*f),0,K),F=k(Math.round(S.w*(1+2*f)),1,X-$),_=k(Math.round(S.h*(1+2*f)),1,K-U),H=ge({x:$,y:U,w:F,h:_},X,K,.12);Z&&pe(Z,M,H.x,H.y,H.w,H.h,v,z.FEATHER_PX)}const J=performance.now();e.setPerfReport({count:q.length,total:J-c,timings:{preprocess:h-c,run:y-h,post:J-y,total:J-c}})},[n,r]),{blurStrength:b,confThresh:C,featherPx:p,setPerfReport:x}=e,u=l.useCallback(async()=>{const M=n.current,t=r.current,c=z.PAD_RATIO;if(!M||!t)return;const v=t.getContext("2d");if(!v)return;const o=Math.max(1,Math.round(b)),f=k(C??.5,.01,.99),w=performance.now(),N=G.filter(R=>(R.score??1)>=f);for(const R of N){const I=t.width,j=t.height,h=k(Math.round(R.x-R.w*c),0,I),d=k(Math.round(R.y-R.h*c),0,j),E=k(Math.round(R.w*(1+2*c)),1,I-h),g=k(Math.round(R.h*(1+2*c)),1,j-d),y=ge({x:h,y:d,w:E,h:g},I,j,.12);pe(v,M,y.x,y.y,y.w,y.h,o,p??0)}const T=performance.now();x({count:N.length,total:T-w,timings:{preprocess:0,run:0,post:T-w,total:T-w}})},[n,r,b,C,p,x]);return l.useImperativeHandle(i,()=>({run:m,redraw:u,getDetections:()=>G.slice(),reset:()=>{G=[]}}),[m,u]),null});function wt({controlName:n,count:r=0,blurVal:e,setBlurVal:i,confVal:a,setThreshVal:m,featherVal:b,setFeatherVal:C,busy:p=!1}){const x=l.useId(),u=l.useId(),M=l.useId();return s.jsx(ne,{className:"shadow-sm border-0 mb-3 control-panel-card",children:s.jsxs(ne.Body,{children:[s.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-2",children:[s.jsx(ne.Title,{as:"p",className:"mb-0",children:n}),s.jsx(je,{bg:"secondary",className:"bg-opacity-10 border border-secondary border-opacity-25 px-2 py-1 small",children:r})]}),s.jsxs("div",{className:"control-row my-2",children:[s.jsx("label",{htmlFor:x,className:"mb-0",children:"Blur Opacity"}),s.jsx("div",{className:"control-slider",children:s.jsx(se.Range,{id:x,min:1,max:80,step:1,value:e,disabled:p,onChange:t=>i(Number(t.currentTarget.value)),className:"form-range themed-range",style:{"--min":1,"--max":80,"--value":e,"--bs-form-range-track-height":"8px","--bs-form-range-track-bg":"#e2e8f0"}})}),s.jsxs("span",{className:"value-badge",children:[s.jsx("span",{"aria-hidden":!0,className:"num",children:e})," ",s.jsx("span",{"aria-hidden":!0,className:"unit",children:"px"}),s.jsxs("span",{className:"visually-hidden",children:[e," px"]})]})]}),s.jsxs("div",{className:"control-row my-2",children:[s.jsx("label",{htmlFor:u,className:"mb-0",children:"Filter"}),s.jsx("div",{className:"control-slider",children:s.jsx(se.Range,{id:u,min:0,max:100,step:1,value:Math.round(a*100),disabled:p,onChange:t=>m(Number(t.currentTarget.value)/100),className:"form-range themed-range",style:{"--min":0,"--max":100,"--value":Math.round(a*100),"--bs-form-range-track-height":"8px","--bs-form-range-track-bg":"#e2e8f0"}})}),s.jsxs("span",{className:"value-badge",children:[s.jsx("span",{"aria-hidden":!0,className:"num",children:Math.round(a*100)})," ",s.jsx("span",{"aria-hidden":!0,className:"unit",children:"%"}),s.jsxs("span",{className:"visually-hidden",children:[Math.round(a*100)," %"]})]})]}),s.jsxs("div",{className:"control-row my-2",children:[s.jsx("label",{htmlFor:M,className:"mb-0",children:"Feather"}),s.jsx("div",{className:"control-slider",children:s.jsx(se.Range,{id:M,min:0,max:100,step:.5,value:b,disabled:p,onChange:t=>C(Number(t.currentTarget.value)),className:"form-range themed-range",style:{"--min":0,"--max":100,"--value":b,"--bs-form-range-track-bg":"#e2e8f0"}})}),s.jsxs("span",{className:"value-badge",children:[s.jsx("span",{"aria-hidden":!0,className:"num",children:Math.round(b)})," ",s.jsx("span",{"aria-hidden":!0,className:"unit",children:"px"}),s.jsxs("span",{className:"visually-hidden",children:[Math.round(b),"px"]})]})]})]})})}const Ne=l.memo(wt),bt=({onClickRefreshHandler:n,onClickDownloadHandler:r,busy:e})=>s.jsxs(Ae,{direction:"horizontal",gap:2,className:"flex-wrap",children:[s.jsx(be,{className:"action-btn",size:"sm",variant:"outline-secondary",title:"Download scrubbed","aria-label":"Download scrubbed",onClick:r,disabled:e,children:s.jsx(_e,{})}),s.jsx(be,{className:"action-btn",size:"sm",variant:"outline-secondary",title:"Refresh","aria-label":"Refresh",onClick:n,disabled:e,children:s.jsx(He,{})})]}),yt=xe.memo(bt),vt=({onClickRefreshHandler:n,onClickDownloadHandler:r,imgSize:e,setImgSize:i,canvasVisible:a,canvasRef:m,title:b,previewUrl:C,badgeList:p,imgRef:x,busy:u,headerRef:M})=>{if(!x)return s.jsx("div",{children:"No image to preview."});const t="badge-chip",c=o=>{let f=$e;return/simd/i.test(o)&&(f=We),/device|on-?device/i.test(o)&&(f=ze),s.jsxs(je,{className:t,children:[s.jsx(f,{size:12,className:"badge-icon"}),o]},o)},v=!(e.w&&e.h);return s.jsx(Te,{md:8,children:s.jsxs(ne,{className:`shadow-sm border-0 preview-card ${u?"cursor-busy":""} ${v?"is-initial":""}`,style:v?{height:"84%"}:void 0,children:[s.jsxs(ne.Header,{ref:M,className:"bg-light d-flex align-items-center justify-content-between",children:[s.jsxs("div",{className:"d-flex align-items-center gap-2 text-secondary",children:[s.jsx(Be,{className:"text-secondary"}),s.jsx("span",{className:"fw-semibold",children:b})]}),s.jsxs("div",{className:"d-flex align-items-center gap-2",children:[s.jsx("div",{className:"d-flex align-items-center gap-1",children:p.map(o=>c(o))}),s.jsx(yt,{onClickRefreshHandler:n,onClickDownloadHandler:r,busy:u||!C})]})]}),s.jsxs("div",{className:"bg-body-tertiary position-relative preview-stage",style:e.w&&e.h?{aspectRatio:`${e.w} / ${e.h}`}:{height:"100%"},children:[s.jsx("img",{ref:x,src:C??"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=",className:"w-100 h-100 object-fit-cover",crossOrigin:"anonymous",onLoad:o=>{const f=o.currentTarget.naturalWidth,w=o.currentTarget.naturalHeight;i({w:f,h:w});const N=m.current;N&&(N.width=f,N.height=w)}}),u&&s.jsx("div",{className:"position-absolute top-50 start-50 translate-middle",children:s.jsx(Ue,{animation:"border",role:"status","aria-label":"processing"})}),s.jsx("canvas",{ref:m,className:`position-absolute top-0 start-0 w-100 h-100 fade-canvas ${a?"is-visible":""}`})]})]})})},Mt=xe.memo(vt);function Ct({onFilePickHandler:n,dragOver:r,setDragOver:e,busy:i}){return l.useEffect(()=>{const a=m=>{const p=Array.from(m.clipboardData?.items??[]).find(x=>x.type.startsWith("image/"))?.getAsFile();p&&n(p)};return window.addEventListener("paste",a),()=>window.removeEventListener("paste",a)},[n]),s.jsx(se.Group,{className:"mb-3",children:s.jsxs("label",{className:"w-100",onDragOver:a=>{a.preventDefault(),e(!0)},onDragLeave:()=>e(!1),onDrop:a=>{a.preventDefault(),e(!1);const m=a.dataTransfer.files?.[0];m&&n(m)},children:[s.jsx("div",{className:`d-grid place-items-center text-center p-4 rounded ${r?"border border-2 border-primary bg-primary bg-opacity-10":"border border-2 border-secondary-subtle bg-light-subtle"} file-drop`,children:s.jsxs("div",{className:"text-secondary",children:[s.jsx(Xe,{className:"mb-1 me-1 text-secondary"}),s.jsx("div",{className:"fw-semibold",children:"Drag & Drop"}),s.jsx("div",{className:"small text-muted",children:"or click to choose a file"})]})}),s.jsx(se.Control,{type:"file",accept:"image/*",className:"visually-hidden",disabled:i,onChange:a=>{const m=a.currentTarget.files?.[0];m&&n(m),a.currentTarget.value=""}})]})})}const Et=800,Rt=600,Nt=30,Ie=l.forwardRef((n,r)=>{const{width:e=Et,height:i=Rt,image:a=null,brushSize:m=Nt,brushColor:b="rgba(0,0,0,0.6)",mode:C="paint",showGrid:p=!1,pixelRatio:x,onChange:u}=n,M=l.useRef(null),t=l.useRef(null),c=l.useRef(null),v=l.useRef(null),o=l.useRef(!1),f=l.useRef(null),w=x&&x>0?x:window.devicePixelRatio||1;l.useImperativeHandle(r,()=>({fillMaskRects:(h,d="rgba(0,0,0,1)")=>{const E=c.current;if(!E)return;const g=E.getContext("2d");g&&(g.save(),g.globalCompositeOperation="source-over",g.fillStyle=d,h.forEach(y=>g.fillRect(y.x,y.y,y.w,y.h)),g.restore(),u?.(N()||""))},exportImage:(h=!0)=>{const d=t.current,E=c.current;if(!d)return null;const g=document.createElement("canvas");g.width=d.width,g.height=d.height;const y=g.getContext("2d");return y?(y.drawImage(d,0,0),h&&E&&y.drawImage(E,0,0),g.toDataURL("image/png")):null},clearMask:()=>{const h=c.current;if(!h)return;const d=h.getContext("2d");d&&(d.clearRect(0,0,h.width,h.height),u&&u(N()||""))},loadImage:async h=>{await T(h)},getMaskDataURL:()=>N()}));const N=l.useCallback(()=>{const h=c.current;return h?h.toDataURL("image/png"):null},[]);l.useEffect(()=>{const h=t.current,d=c.current;if(!h||!d)return;const E=Math.max(1,Math.floor(e)),g=Math.max(1,Math.floor(i));h.style.width=`${E}px`,h.style.height=`${g}px`,d.style.width=`${E}px`,d.style.height=`${g}px`,h.width=Math.floor(E*w),h.height=Math.floor(g*w),d.width=Math.floor(E*w),d.height=Math.floor(g*w);const y=h.getContext("2d"),P=d.getContext("2d");y&&(y.setTransform(w,0,0,w,0,0),y.clearRect(0,0,E,g)),P&&(P.setTransform(w,0,0,w,0,0),P.clearRect(0,0,E,g))},[e,i,w]);const T=l.useCallback(h=>new Promise(d=>{const E=t.current;if(!E){d();return}const g=E.getContext("2d");if(!g){d();return}if(!h){g.clearRect(0,0,e,i),d();return}const y=new Image;v.current=y,y.crossOrigin="anonymous",y.onload=()=>{g.clearRect(0,0,e,i);const P=e/i,O=y.width/y.height;let Z=e,q=i,J=0,S=0;O>P?(Z=e,q=e/O,S=(i-q)/2):(q=i,Z=i*O,J=(e-Z)/2),g.drawImage(y,J,S,Z,q),d()},y.onerror=()=>{g.clearRect(0,0,e,i),d()},y.src=h}),[e,i]);l.useEffect(()=>{T(a)},[a]);const R=l.useCallback(h=>{const d=c.current?.getBoundingClientRect(),{clientX:E=0,clientY:g=0}=h;if(!d)return{x:E,y:g};const y=(E-d.left)*(c.current.width/d.width)/w,P=(g-d.top)*(c.current.height/d.height)/w;return{x:y,y:P}},[w]),I=l.useCallback((h,d)=>{const E=c.current;if(!E)return;const g=E.getContext("2d");g&&(g.lineCap="round",g.lineJoin="round",g.lineWidth=m,C==="paint"?(g.globalCompositeOperation="source-over",g.strokeStyle=b):(g.globalCompositeOperation="destination-out",g.strokeStyle="rgba(0,0,0,1)"),g.beginPath(),h?g.moveTo(h.x,h.y):g.moveTo(d.x-.01,d.y),g.lineTo(d.x,d.y),g.stroke(),g.closePath())},[m,b,C]);l.useEffect(()=>{const h=c.current;if(!h)return;const d=y=>{h.setPointerCapture(y.pointerId),o.current=!0,f.current=R(y),I(null,f.current)},E=y=>{if(!o.current)return;const P=R(y);I(f.current,P),f.current=P},g=y=>{if(o.current&&(o.current=!1,f.current=null,u)){const P=j(!1);P&&u(P)}try{h.releasePointerCapture(y.pointerId)}catch{}};return h.addEventListener("pointerdown",d),window.addEventListener("pointermove",E),window.addEventListener("pointerup",g),()=>{h.removeEventListener("pointerdown",d),window.removeEventListener("pointermove",E),window.removeEventListener("pointerup",g)}},[I,R,u]);const j=l.useCallback((h=!1)=>{const d=t.current,E=c.current;if(!d)return null;if(h&&E)return E.toDataURL("image/png");const g=document.createElement("canvas");g.width=d.width,g.height=d.height;const y=g.getContext("2d");return y?(y.drawImage(d,0,0),E&&y.drawImage(E,0,0),g.toDataURL("image/png")):null},[]);return l.useEffect(()=>{if(!p)return;const h=c.current;if(!h)return;const d=h.getContext("2d");if(!d)return;(()=>{const g=e,y=i;d.save(),d.setLineDash([4,4]),d.globalCompositeOperation="source-over",d.strokeStyle="rgba(255,255,255,0.15)",d.lineWidth=1;const P=Math.max(10,Math.floor(Math.min(e,i)/20));for(let O=P;O<g;O+=P)d.beginPath(),d.moveTo(O,0),d.lineTo(O,y),d.stroke();for(let O=P;O<y;O+=P)d.beginPath(),d.moveTo(0,O),d.lineTo(g,O),d.stroke();d.restore()})()},[p,e,i]),s.jsxs("div",{ref:M,className:"canvas-container",style:{width:`${e}px`,height:`${i}px`},children:[s.jsx("canvas",{ref:t,width:Math.max(1,Math.floor(e*w)),height:Math.max(1,Math.floor(i*w)),className:"canvas-layer"}),s.jsx("canvas",{ref:c,width:Math.max(1,Math.floor(e*w)),height:Math.max(1,Math.floor(i*w)),className:"canvas-layer"})]})});Ie.displayName="Canvas";l.forwardRef(function({imageURL:r,blurVal:e,width:i=900,height:a=600},m){const b=l.useRef(null),C=l.useRef(null);l.useEffect(()=>{r&&b.current?.loadImage(r)},[r]);const p=t=>new Promise((c,v)=>{const o=new Image;o.crossOrigin="anonymous",o.onload=()=>c(o),o.onerror=v,o.src=t});function x(t,c,v,o,f){const w=o/f,N=c/v;let T,R,I=0,j=0,h;return N>w?(T=o,R=o/N,j=(f-R)/2,h=T/c):(R=f,T=f*N,I=(o-T)/2,h=R/v),{x:I+t.x*h,y:j+t.y*h,w:t.w*h,h:t.h*h}}const u=l.useCallback(async()=>{if(!C.current||!r)return;const t=b.current?.getMaskDataURL();if(!t)return;const[c,v]=await Promise.all([p(t),p(r)]),o=c.width,f=c.height,w=C.current;w.width=o,w.height=f;const N=w.getContext("2d");if(!N)return;N.clearRect(0,0,o,f),N.globalCompositeOperation="source-over",N.drawImage(v,0,0,o,f);const T=document.createElement("canvas");T.width=o,T.height=f;const R=T.getContext("2d"),I=Math.max(1,Math.round(e/100*40));R.filter=`blur(${I}px)`,R.drawImage(v,0,0,o,f),R.filter="none",R.globalCompositeOperation="destination-in",R.drawImage(c,0,0,o,f),R.globalCompositeOperation="source-over",N.drawImage(T,0,0)},[r,e]),M=l.useCallback(()=>{u()},[u]);return l.useEffect(()=>{u()},[u]),l.useImperativeHandle(m,()=>({prefillFromDetections:async t=>{if(!r)return;const c=await p(r),v=t.map(o=>x(o,c.naturalWidth,c.naturalHeight,i,a));b.current?.fillMaskRects(v,"rgba(0,0,0,1)"),await u()},exportResult:()=>C.current?.toDataURL("image/png")??null})),s.jsxs("div",{className:"plate-redactor",children:[s.jsx(Ie,{ref:b,width:i,height:a,image:r||null,brushSize:30,brushColor:"rgba(0,0,0,1)",mode:"paint",onChange:M}),s.jsx("canvas",{ref:C,className:"canvas-output",style:{width:i,height:a}})]})});function jt(){const[n,r]=l.useState(V.RUN_LICENSE_PLATE_DETECTION),[e,i]=l.useState(V.FEATHER_PX),[a,m]=l.useState(V.BLUR_DENSITY),[b,C]=l.useState(V.CONFIDENCE_THRESHOLD),[p,x]=l.useState(z.FEATHER_PX),[u,M]=l.useState(z.RUN_FACE_DETECTION),[t,c]=l.useState(z.BLUR_DENSITY),[v,o]=l.useState(z.CONFIDENCE_THRESHOLD),[f,w]=l.useState(Ee),[N,T]=l.useState(Ee),[R]=l.useState(V.MODEL_SIZE),[I,j]=l.useState(lt),[h,d]=l.useState(!1),[E,g]=l.useState(null),[y,P]=l.useState(!1),[O,Z]=l.useState(null),[q,J]=l.useState(!1),S=l.useRef(null),X=l.useRef(null),[K,$]=l.useState(0),U=l.useRef(null),F=l.useRef(null),_=l.useRef(null),H=l.useRef(null),ae=l.useRef(null);l.useEffect(()=>{const D=S.current,A=X.current;if(!D)return;const L=()=>{const W=D?.getBoundingClientRect(),ee=A?.getBoundingClientRect();if(!W||!ee)return;const re=Math.max(0,Math.floor(W.bottom-ee.bottom));$(re)};let Y=null;typeof ResizeObserver<"u"&&(Y=new ResizeObserver(()=>L()),Y.observe(D)),window.addEventListener("resize",L);const B=window.setTimeout(L,0);return()=>{window.clearTimeout(B),window.removeEventListener("resize",L);try{Y?.disconnect()}catch{console.log("ResizeObserver disconnect error")}}},[]),l.useEffect(()=>{if(!E)return;const D=F.current,A=D?.getContext("2d");if(!D||!A)return;const L=[],Y=window.setTimeout(()=>{const B=requestAnimationFrame(()=>{A.clearRect(0,0,D.width,D.height),n&&H.current?.redraw(),u&&_.current?.redraw(),J(W=>W||!0)});L.push(()=>cancelAnimationFrame(B))},32);return L.push(()=>clearTimeout(Y)),()=>{for(const B of L)B()}},[E,n,u,a,b,e,t,v,p]);const ce=l.useCallback(async()=>{d(!0);const D=U?.current;if(!F.current||!D){d(!1);return}try{await H.current?.run(),ae.current?.prefillFromDetections(H.current?.getDetections?.()??[]),u&&await _.current?.run()}catch(L){console.log(`Detection error: ${L instanceof Error?L.message:String(L)}`)}finally{J(!0),d(!1)}},[u]),ie=l.useMemo(()=>["SIMD","1 Thread","On-Device"],[]),le=D=>`${D.toFixed(1)}ms`,de=l.useCallback(()=>{const D=F.current,A=D?.getContext("2d");D&&A&&A.clearRect(0,0,D.width,D.height)},[]),Q=l.useCallback(D=>{const A=URL.createObjectURL(D);Z(D.name),g(L=>(L?.startsWith("blob:")&&URL.revokeObjectURL(L),A))},[]),Oe=l.useCallback(()=>{const D=U.current,A=F.current;if(!D||!A)return;const L=A.width,Y=A.height,B=document.createElement("canvas");B.width=L,B.height=Y;const W=B.getContext("2d");if(!W)return;W.drawImage(D,0,0,L,Y),W.drawImage(A,0,0,L,Y);const ee=O??"image.jpg",re=ee.lastIndexOf("."),Fe=re>=0?ee.slice(0,re):ee,he=(re>=0?ee.slice(re+1):"jpg").toLowerCase(),we=he==="png"?"png":"jpg",ke=we==="png"?"image/png":"image/jpeg",Le=`${Fe}-redacted.${we}`;et(B,Le,ke,.92)},[O]);return l.useEffect(()=>{const D=A=>{const B=Array.from(A.clipboardData?.items??[]).find(W=>W.type.startsWith("image/"))?.getAsFile();B&&Q(B)};return window.addEventListener("paste",D),()=>window.removeEventListener("paste",D)},[Q]),l.useEffect(()=>()=>{de(),E?.startsWith("blob:")&&URL.revokeObjectURL(E)},[de,E]),s.jsxs("div",{className:`bg-light min-vh-100 ${h?"cursor-busy":""}`,children:[s.jsx(ut,{ref:H,imgRef:U,canvasRef:F,opts:{modelSize:R,confThresh:b,blurStrength:a,setPerfReport:w,featherPx:e}}),s.jsx(xt,{ref:_,imgRef:U,canvasRef:F,opts:{modelSize:544,confThresh:v,blurStrength:t,setPerfReport:T,featherPx:p}}),s.jsxs(Ye,{className:"g-3",children:[s.jsx(Mt,{imgSize:I,setImgSize:j,onClickRefreshHandler:ce,onClickDownloadHandler:Oe,canvasRef:F,title:"Preview",previewUrl:E??null,badgeList:[...ie],imgRef:U,canvasVisible:q,busy:h,initialHeight:K,headerRef:X}),it,s.jsx(Te,{md:4,children:s.jsx("div",{ref:S,className:"sticky-top sticky-offset-1",children:s.jsx(ne,{className:"shadow-sm border-0",children:s.jsxs(ne.Body,{children:[s.jsx(Ct,{onFilePickHandler:Q,setDragOver:P,dragOver:y,busy:h}),s.jsx("div",{className:"px-2 mb-3",children:s.jsxs("div",{className:"d-flex align-items-center justify-content-between stack-between-sm",children:[s.jsx(se.Check,{type:"switch",id:"sw-plates",label:"Blur License Plates",checked:n,onChange:D=>r(D.currentTarget.checked),...h&&{disabled:!0}}),s.jsx("span",{className:"badge badge-kpi",style:n?{backgroundColor:"var(--bs-primary)",color:"#fff"}:{backgroundColor:"#dee2e6",color:"#6c757d"},children:`${f.count} · ${le(f.total)}`})]})}),s.jsx("div",{className:"px-2 mb-3",children:s.jsxs("div",{className:"d-flex align-items-center justify-content-between stack-between-sm",children:[s.jsx(se.Check,{type:"switch",id:"sw-faces",label:"Blur Faces",checked:u,onChange:D=>M(D.currentTarget.checked),...h&&{disabled:!0}}),s.jsx("span",{className:"badge badge-kpi",style:u?{backgroundColor:"var(--bs-primary)",color:"#fff"}:{backgroundColor:"#dee2e6",color:"#6c757d"},children:`${N.count} · ${le(N.total)}`})]})}),n&&s.jsx(Ne,{blurVal:a,busy:h,confVal:b,controlName:"License Plate Redaction",count:f.count,setBlurVal:m,setThreshVal:C,featherVal:e,setFeatherVal:i}),u&&s.jsx(Ne,{blurVal:t,busy:h,confVal:v,controlName:"Facial Redaction",count:N.count,setBlurVal:c,setThreshVal:o,featherVal:p,setFeatherVal:x})]})})})})]})]})}function Tt(){const n=l.useRef(null);return l.useEffect(()=>{const r=n.current;return()=>{r&&window.clearTimeout(r)}},[]),s.jsx(ye,{fluid:!0,children:s.jsx("div",{className:"bg-light min-vh-100 app-root",children:s.jsxs(ye,{className:"mt-n4 mb-5",children:[s.jsx(Qe,{}),s.jsx(jt,{})]})})})}Se();const Pe=document.getElementById("root");if(!Pe)throw new Error("Root element #root not found");Ge.createRoot(Pe).render(s.jsx(l.StrictMode,{children:s.jsx(Tt,{})}));
